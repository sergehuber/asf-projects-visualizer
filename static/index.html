<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASF Projects Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
        }
        .project-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .project-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .project-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .project-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .category-section {
            margin-bottom: 24px;
        }
        .category-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }
        .filtered-project-card {
            display: flex;
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .filtered-project-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stack-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: white;
        }
        .stack-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .stack-description {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 12px;
        }
        .stack-projects {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .stack-project {
            font-size: 12px;
            background-color: #edf2f7;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .similar-projects {
            font-size: 8px;
            color: #4a5568;
            margin-top: 2px;
        }
        .feature-tag {
            font-size: 10px;
            background-color: #e2e8f0;
            padding: 2px 4px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 id="apache-projects-visualizer" class="text-3xl font-bold mb-8 text-gray-800">ASF Projects Visualizer</h1>

        <div class="mb-6">
            <div class="flex space-x-4 mb-4">
                <input type="text" id="searchInput" placeholder="Search projects by name" class="flex-grow p-2 border rounded">
                <input type="text" id="queryInput" placeholder="Query Projects" class="flex-grow p-2 border rounded">
                <button id="queryButton" class="bg-blue-500 text-white px-4 py-2 rounded">Query</button>
                <button id="clearButton" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Clear</button>
            </div>
            <div class="flex items-center mb-4">
                <button id="toggleAllCategories" class="bg-blue-500 text-white px-4 py-2 rounded mr-4">Deselect All Categories</button>
                <div id="categoryFilters" class="flex flex-wrap gap-4"></div>
            </div>
        </div>

        <div id="defaultView">
            <div id="visualization"></div>
        </div>

        <div id="filteredView" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Suggested Stacks</h2>
            <div id="suggestedStacks" class="bg-white p-4 rounded shadow overflow-y-auto" style="max-height: 600px;"></div>
        </div>
    </div>

    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold"></h2>
                <button id="closeModal" class="text-2xl">&times;</button>
            </div>
            <div id="projectDetails"></div>
        </div>
    </div>

    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg">
            <p>Querying projects...</p>
        </div>
    </div>

    <div id="comparisonModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Project Comparison</h2>
                <button id="closeComparisonModal" class="text-2xl">&times;</button>
            </div>
            <div id="comparisonDetails" class="grid grid-cols-2 gap-4"></div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const queryInput = document.getElementById('queryInput');
        const queryButton = document.getElementById('queryButton');
        const clearButton = document.getElementById('clearButton');
        const projectModal = document.getElementById('projectModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const projectDetails = document.getElementById('projectDetails');
        const loading = document.getElementById('loading');
        const suggestedStack = document.getElementById('suggestedStack');
        const defaultView = document.getElementById('defaultView');
        const filteredView = document.getElementById('filteredView');
        const categoryFilters = document.getElementById('categoryFilters');
        const visualization = document.getElementById('visualization');

        let allProjects = [];

        queryButton.addEventListener('click', queryProjects);
        clearButton.addEventListener('click', clearQuery);
        closeModal.addEventListener('click', () => projectModal.classList.add('hidden'));
        queryInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                queryProjects();
            }
        });
        searchInput.addEventListener('input', filterProjectsByName);

        loadProjects();

        function showLoading() {
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            loading.classList.add('hidden');
        }

        const toggleAllCategoriesButton = document.getElementById('toggleAllCategories');
        let allCategoriesSelected = true;

        toggleAllCategoriesButton.addEventListener('click', toggleAllCategories);

        function loadProjects() {
            showLoading();
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    allProjects = data.categories;
                    renderCategoryFilters(data.categories);
                    renderProjects(data.categories);
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                    hideLoading();
                });
        }

        function renderCategoryFilters(categories) {
            categoryFilters.innerHTML = '';
            categories.forEach(category => {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'flex items-center';
                const isChecked = true;
                filterDiv.innerHTML = `
                    <input type="checkbox" id="${category.name}" name="${category.name}" ${isChecked ? 'checked' : ''} class="mr-2 category-checkbox">
                    <label for="${category.name}" class="text-sm">${category.name} (${category.projects.length})</label>
                `;
                const checkbox = filterDiv.querySelector('input');
                checkbox.addEventListener('change', () => toggleCategory(category.name, checkbox.checked));
                categoryFilters.appendChild(filterDiv);
            });
            updateToggleAllButton();
        }

        function toggleAllCategories() {
            allCategoriesSelected = !allCategoriesSelected;
            const checkboxes = document.querySelectorAll('.category-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = allCategoriesSelected;
                toggleCategory(checkbox.name, allCategoriesSelected, false);
            });
            updateToggleAllButton();
        }

        function updateToggleAllButton() {
            const checkboxes = document.querySelectorAll('.category-checkbox');
            allCategoriesSelected = Array.from(checkboxes).every(checkbox => checkbox.checked);
            toggleAllCategoriesButton.textContent = allCategoriesSelected ? 'Deselect All' : 'Select All';
        }

        function toggleCategory(categoryName, isChecked, shouldUpdateToggleAllButton = true) {
            const categorySection = document.querySelector(`.category-section[data-category="${categoryName}"]`);
            if (categorySection) {
                categorySection.style.display = isChecked ? 'block' : 'none';
            }
            if (shouldUpdateToggleAllButton) {
                updateToggleAllButton();
            }
        }

        function renderProjects(categories) {
            visualization.innerHTML = '';
            categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section mb-8';
                categorySection.dataset.category = category.name;
                categorySection.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">${category.name}</h2>
                    <div class="project-grid grid grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
                `;
                const projectGrid = categorySection.querySelector('.project-grid');
                category.projects.forEach(project => {
                    const projectCard = createProjectCard(project, category.name);
                    projectGrid.appendChild(projectCard);
                });
                visualization.appendChild(categorySection);
            });
            toggleCategory('Retired', false);
        }

        function createProjectCard(project, categoryName, isFilteredView = false) {
            const card = document.createElement('div');
            const logoPlaceholder = generateLogoPlaceholder(project.name, isFilteredView ? 60 : 32);
            
            if (isFilteredView) {
                card.className = 'filtered-project-card';
                card.innerHTML = `
                    <div class="w-16 h-16 mr-3 flex-shrink-0">
                        ${project.logo ? `<img src="${project.logo}" alt="${project.name} logo" class="w-full h-full object-contain">` : logoPlaceholder}
                    </div>
                    <div class="flex-grow">
                        <h3 class="text-base font-semibold mb-1">${project.name}</h3>
                        <p class="text-xs text-gray-600 mb-1">${project.shortdesc}</p>
                        <p class="text-xs text-gray-500"><strong>Reason:</strong> ${project.filter_explanation}</p>
                        <p class="text-xs text-gray-500 mt-2"><strong>Similar Projects:</strong> ${project.similar_projects.join(', ') || 'None'}</p>
                    </div>
                `;
            } else {
                card.className = 'project-card';
                card.dataset.category = categoryName;
                card.innerHTML = `
                    <div class="w-8 h-8 mb-1">
                        ${project.logo ? `<img src="${project.logo}" alt="${project.name} logo" class="w-full h-full object-contain">` : logoPlaceholder}
                    </div>
                    <div class="project-name">${project.name}</div>
                    <div class="similar-projects text-xs text-gray-500">${project.similar_projects.slice(0, 2).join(', ')}</div>
                `;
            }
            
            card.addEventListener('click', () => showProjectDetails(project));
            return card;
        }

        function generateLogoPlaceholder(projectName) {
            const initials = projectName
                .split(' ')
                .map(word => word[0])
                .join('')
                .substring(0, 2)
                .toUpperCase();

            const colors = [
                '#FFA07A', '#98FB98', '#87CEFA', '#DDA0DD', '#F0E68C',
                '#E6E6FA', '#FFA500', '#20B2AA', '#FF6347', '#00FA9A'
            ];
            const colorIndex = projectName.length % colors.length;
            const bgColor = colors[colorIndex];

            return `
                <svg width="80" height="80" xmlns="http://www.w3.org/2000/svg">
                    <rect width="80" height="80" fill="${bgColor}" />
                    <text x="40" y="40" font-family="Arial, sans-serif" font-size="32" fill="#000000" text-anchor="middle" dominant-baseline="central">${initials}</text>
                </svg>
            `;
        }

        function queryProjects() {
            const query = queryInput.value;
            if (query) {
                showLoading();
                fetch(`/api/filter?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        renderSuggestedStacks(data.stacks, data.projects);
                        defaultView.classList.add('hidden');
                        filteredView.classList.remove('hidden');
                        categoryFilters.classList.add('hidden');
                        document.getElementById('toggleAllCategories').classList.add('hidden');
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error querying projects:', error);
                        hideLoading();
                    });
            }
        }


        function renderSuggestedStacks(stacks, projects) {
            const suggestedStacksContainer = document.getElementById('suggestedStacks');
            suggestedStacksContainer.innerHTML = '';

            if (stacks.length === 0) {
                suggestedStacksContainer.innerHTML = '<p>No suggested stacks found.</p>';
                return;
            }

            stacks.forEach(stack => {
                const stackCard = document.createElement('div');
                stackCard.className = 'stack-card';
                stackCard.innerHTML = `
                    <h3 class="stack-title">${stack.name}</h3>
                    <p class="stack-description">${stack.description}</p>
                    <div class="stack-projects">
                        ${stack.projects.map(projectName => `<span class="stack-project">${projectName}</span>`).join('')}
                    </div>
                `;
                suggestedStacksContainer.appendChild(stackCard);
            });

            // Render filtered projects
            const filteredProjectsCard = document.createElement('div');
            filteredProjectsCard.className = 'stack-card';
            filteredProjectsCard.innerHTML = '<h3 class="stack-title">Relevant Projects</h3>';
            const projectList = document.createElement('div');
            projectList.className = 'space-y-4';
            projects.forEach(project => {
                const projectCard = createProjectCard(project, project.category, true);
                projectList.appendChild(projectCard);
            });
            filteredProjectsCard.appendChild(projectList);
            suggestedStacksContainer.appendChild(filteredProjectsCard);
        }

        function clearQuery() {
            queryInput.value = '';
            defaultView.classList.remove('hidden');
            filteredView.classList.add('hidden');
            categoryFilters.classList.remove('hidden');
            document.getElementById('toggleAllCategories').classList.remove('hidden');
            suggestedStacks.innerHTML = '';
        }

        function renderSuggestedStack(projects) {
            suggestedStack.innerHTML = '';
            projects.forEach(project => {
                const projectCard = createProjectCard(project, project.category, true);
                suggestedStack.appendChild(projectCard);
            });
        }

        function showProjectDetails(project) {
            modalTitle.textContent = project.name;
            projectDetails.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="w-20 h-20 mr-4">
                        ${project.logo ? `<img src="${project.logo}" alt="${project.name} logo" class="w-full h-full object-contain">` : generateLogoPlaceholder(project.name, 80)}
                    </div>
                    <div>
                        <p><strong>Category:</strong> ${project.category}</p>
                        <p><strong>Programming Language:</strong> ${project.programming_language}</p>
                    </div>
                </div>
                <p><strong>Description:</strong> ${project.description || project.shortdesc}</p>
                ${project.role ? `<p><strong>Role in Stack:</strong> ${project.role}</p>` : ''}
                ${project.filter_explanation ? `<p><strong>Reason for Selection:</strong> ${project.filter_explanation}</p>` : ''}
                <div class="mt-2">
                    <strong>Features:</strong>
                    ${project.features ? project.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('') : 'No features listed'}
                </div>
                <p class="mt-2"><strong>Similar Projects:</strong> ${project.similar_projects.join(', ') || 'None'}</p>
                ${project.homepage ? `<p><strong>Homepage:</strong> <a href="${project.homepage}" target="_blank" class="text-blue-500">${project.homepage}</a></p>` : ''}
                ${project.download_page ? `<p><strong>Download Page:</strong> <a href="${project.download_page}" target="_blank" class="text-blue-500">${project.download_page}</a></p>` : ''}
                <div class="mt-4">
                    <button id="compareButton" class="bg-blue-500 text-white px-4 py-2 rounded">Compare with another project</button>
                </div>
            `;
            document.getElementById('compareButton').addEventListener('click', () => initiateComparison(project.name));
            projectModal.classList.remove('hidden');
        }

        function initiateComparison(projectName) {
            projectModal.classList.add('hidden');
            const otherProject = prompt("Enter the name of the project you want to compare with:");
            if (otherProject) {
                compareProjects(projectName, otherProject);
            } else {
                projectModal.classList.remove('hidden');
            }
        }

        function compareProjects(project1, project2) {
            fetch(`/api/compare?project1=${encodeURIComponent(project1)}&project2=${encodeURIComponent(project2)}`)
                .then(response => response.json())
                .then(data => {
                    const comparisonDetails = document.getElementById('comparisonDetails');
                    comparisonDetails.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold">${data.project1.name}</h3>
                            <p>${data.project1.shortdesc}</p>
                            <p><strong>Category:</strong> ${data.project1.category}</p>
                            <div class="mt-2">
                                <strong>Features:</strong>
                                ${data.project1.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">${data.project2.name}</h3>
                            <p>${data.project2.shortdesc}</p>
                            <p><strong>Category:</strong> ${data.project2.category}</p>
                            <div class="mt-2">
                                <strong>Features:</strong>
                                ${data.project2.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                            </div>
                        </div>
                        <div class="col-span-2 text-center mt-4">
                            <p><strong>Similarity Score:</strong> ${(data.similarity_score * 100).toFixed(2)}%</p>
                        </div>
                    `;
                    document.getElementById('comparisonModal').classList.remove('hidden');
                })
                .catch(error => console.error('Error comparing projects:', error));
        }

        document.getElementById('closeComparisonModal').addEventListener('click', () => {
            document.getElementById('comparisonModal').classList.add('hidden');
        });

        function filterProjectsByName() {
            const searchTerm = searchInput.value.toLowerCase();
            const projectCards = document.querySelectorAll('.project-card');
            
            projectCards.forEach(card => {
                const projectName = card.querySelector('.project-name').textContent.toLowerCase();
                if (projectName.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });

            const categorySections = document.querySelectorAll('.category-section');
            categorySections.forEach(section => {
                const visibleProjects = section.querySelectorAll('.project-card[style="display: flex;"]');
                section.style.display = visibleProjects.length > 0 ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>