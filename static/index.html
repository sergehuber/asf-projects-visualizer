<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apache Projects Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }
        .project-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .project-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .project-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .project-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .category-section {
            margin-bottom: 24px;
        }
        .category-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }
        .filtered-project-card {
            display: flex;
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
        }
        .filtered-project-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .node { stroke: #fff; stroke-width: 1.5px; }
        .link { stroke: #999; stroke-opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 id="apache-projects-visualizer" class="text-3xl font-bold mb-8 text-gray-800">Apache Projects Visualizer</h1>

        <div class="mb-6">
            <div class="flex space-x-4 mb-4">
                <input type="text" id="searchInput" placeholder="Search projects by name" class="flex-grow p-2 border rounded">
                <input type="text" id="queryInput" placeholder="Query Projects" class="flex-grow p-2 border rounded">
                <button id="queryButton" class="bg-blue-500 text-white px-4 py-2 rounded">Query</button>
                <button id="clearButton" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Clear</button>
            </div>
            <div id="categoryFilters" class="flex flex-wrap gap-4 mb-4"></div>
        </div>

        <div id="defaultView">
            <div id="visualization"></div>
        </div>

        <div id="filteredView" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Suggested Stack</h2>
            <div class="flex flex-wrap gap-6">
                <div id="stackVisualization" class="w-full lg:w-1/2 bg-white p-4 rounded shadow"></div>
                <div id="filteredProjectList" class="w-full lg:w-1/2 bg-white p-4 rounded shadow overflow-y-auto" style="max-height: 600px;"></div>
            </div>
        </div>
    </div>

    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold"></h2>
                <button id="closeModal" class="text-2xl">&times;</button>
            </div>
            <div id="projectDetails"></div>
        </div>
    </div>

    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg">
            <p>Loading projects...</p>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const queryInput = document.getElementById('queryInput');
        const queryButton = document.getElementById('queryButton');
        const clearButton = document.getElementById('clearButton');
        const projectModal = document.getElementById('projectModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const projectDetails = document.getElementById('projectDetails');
        const loading = document.getElementById('loading');
        const stackVisualization = document.getElementById('stackVisualization');
        const filteredProjectList = document.getElementById('filteredProjectList');
        const defaultView = document.getElementById('defaultView');
        const filteredView = document.getElementById('filteredView');
        const categoryFilters = document.getElementById('categoryFilters');
        const visualization = document.getElementById('visualization');

        let allProjects = [];

        queryButton.addEventListener('click', queryProjects);
        clearButton.addEventListener('click', clearQuery);
        closeModal.addEventListener('click', () => projectModal.classList.add('hidden'));
        queryInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                queryProjects();
            }
        });
        searchInput.addEventListener('input', filterProjectsByName);

        loadProjects();

        function showLoading() {
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            loading.classList.add('hidden');
        }

        function loadProjects() {
            showLoading();
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    allProjects = data.categories;
                    renderCategoryFilters(data.categories);
                    renderProjects(data.categories);
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                    hideLoading();
                });
        }

        function renderCategoryFilters(categories) {
            categoryFilters.innerHTML = '';
            categories.forEach(category => {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'flex items-center';
                filterDiv.innerHTML = `
                    <input type="checkbox" id="${category.name}" name="${category.name}" checked class="mr-2">
                    <label for="${category.name}" class="text-sm">${category.name} (${category.projects.length})</label>
                `;
                const checkbox = filterDiv.querySelector('input');
                checkbox.addEventListener('change', () => toggleCategory(category.name, checkbox.checked));
                categoryFilters.appendChild(filterDiv);
            });
        }

        function toggleCategory(categoryName, isChecked) {
            const categorySection = document.querySelector(`.category-section[data-category="${categoryName}"]`);
            if (categorySection) {
                categorySection.style.display = isChecked ? 'block' : 'none';
            }
        }

        function renderProjects(categories) {
            visualization.innerHTML = '';
            categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section mb-8';
                categorySection.dataset.category = category.name;
                categorySection.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">${category.name}</h2>
                    <div class="project-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                `;
                const projectGrid = categorySection.querySelector('.project-grid');
                category.projects.forEach(project => {
                    const projectCard = createProjectCard(project, category.name);
                    projectGrid.appendChild(projectCard);
                });
                visualization.appendChild(categorySection);
            });
        }

        function createProjectCard(project, categoryName, isFilteredView = false) {
            const card = document.createElement('div');
            
            if (isFilteredView) {
                card.className = 'filtered-project-card';
                card.innerHTML = `
                    <img src="${project.logo || '/api/placeholder/80/80'}" alt="${project.name} logo" class="w-20 h-20 mr-4 flex-shrink-0">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold mb-1">${project.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">${project.shortdesc}</p>
                        <p class="text-xs text-gray-500"><strong>Reason:</strong> ${project.filter_explanation}</p>
                    </div>
                `;
            } else {
                card.className = 'project-card bg-white p-4 rounded shadow cursor-pointer transition-shadow hover:shadow-md';
                card.dataset.category = categoryName;
                card.innerHTML = `
                    <img src="${project.logo || '/api/placeholder/80/80'}" alt="${project.name} logo" class="w-20 h-20 mx-auto mb-2">
                    <div class="project-name text-center font-semibold">${project.name}</div>
                `;
            }
            
            card.addEventListener('click', () => showProjectDetails(project));
            return card;
        }

        function queryProjects() {
            const query = queryInput.value;
            if (query) {
                loading.classList.remove('hidden');
                fetch(`/api/filter?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        renderStack(data.stack, data.graph);
                        renderFilteredProjectList(data.projects);
                        defaultView.classList.add('hidden');
                        filteredView.classList.remove('hidden');
                        categoryFilters.classList.add('hidden');
                        loading.classList.add('hidden');
                    });
            }
        }

        function clearQuery() {
            queryInput.value = '';
            searchInput.value = '';
            defaultView.classList.remove('hidden');
            filteredView.classList.add('hidden');
            categoryFilters.classList.remove('hidden');
            stackVisualization.innerHTML = '';
            filteredProjectList.innerHTML = '';
            renderProjects(allProjects);
        }

        function renderStack(stack, graph) {
            stackVisualization.innerHTML = '<h3 class="text-xl font-bold mb-4">Project Stack Visualization</h3>';
            const width = stackVisualization.clientWidth;
            const height = 400;

            const svg = d3.select(stackVisualization)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const simulation = d3.forceSimulation(graph.nodes)
                .force('link', d3.forceLink(graph.links).id(d => d.id))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));

            const link = svg.append('g')
                .selectAll('line')
                .data(graph.links)
                .enter().append('line')
                .attr('class', 'link');

            const node = svg.append('g')
                .selectAll('circle')
                .data(graph.nodes)
                .enter().append('circle')
                .attr('class', 'node')
                .attr('r', 10)
                .attr('fill', d => d3.schemeCategory10[d.group % 10])
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('title')
                .text(d => d.id);

            const label = svg.append('g')
                .selectAll('text')
                .data(graph.nodes)
                .enter().append('text')
                .attr('dx', 12)
                .attr('dy', '.35em')
                .text(d => d.id);

            simulation
                .nodes(graph.nodes)
                .on('tick', ticked);

            simulation.force('link')
                .links(graph.links);

            function ticked() {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            }

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        function renderFilteredProjectList(projects) {
            filteredProjectList.innerHTML = '<h3 class="text-xl font-bold mb-4">Filtered Projects</h3>';
            projects.forEach(project => {
                const projectCard = createProjectCard(project, project.category, true);
                filteredProjectList.appendChild(projectCard);
            });
        }

        function showProjectDetails(project) {
            modalTitle.textContent = project.name;
            projectDetails.innerHTML = `
                <div class="flex items-center mb-4">
                    <img src="${project.logo || '/api/placeholder/80/80'}" alt="${project.name} logo" class="w-20 h-20 mr-4">
                    <div>
                        <p><strong>Category:</strong> ${project.category}</p>
                        <p><strong>Programming Language:</strong> ${project.programming_language}</p>
                    </div>
                </div>
                <p><strong>Description:</strong> ${project.description || project.shortdesc}</p>
                ${project.role ? `<p><strong>Role in Stack:</strong> ${project.role}</p>` : ''}
                ${project.filter_explanation ? `<p><strong>Reason for Selection:</strong> ${project.filter_explanation}</p>` : ''}
                ${project.homepage ? `<p><strong>Homepage:</strong> <a href="${project.homepage}" target="_blank" class="text-blue-500">${project.homepage}</a></p>` : ''}
                ${project.download_page ? `<p><strong>Download Page:</strong> <a href="${project.download_page}" target="_blank" class="text-blue-500">${project.download_page}</a></p>` : ''}
            `;
            projectModal.classList.remove('hidden');
        }

        function filterProjectsByName() {
            const searchTerm = searchInput.value.toLowerCase();
            const projectCards = document.querySelectorAll('.project-card');
            
            projectCards.forEach(card => {
                const projectName = card.querySelector('.project-name').textContent.toLowerCase();
                if (projectName.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide category sections based on whether they have visible projects
            const categorySections = document.querySelectorAll('.category-section');
            categorySections.forEach(section => {
                const visibleProjects = section.querySelectorAll('.project-card[style="display: flex;"]');
                section.style.display = visibleProjects.length > 0 ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>